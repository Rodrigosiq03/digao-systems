name: pulumi-rabbitmq

on:
  workflow_dispatch:
    inputs:
      stack:
        description: "Pulumi stack select (dev|homolog|prod)"
        required: true
        type: choice
        default: dev
        options:
          - dev
          - homolog
          - prod
      ref:
        description: "Git ref to deploy (branch or SHA)"
        required: false
        default: "main"

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: pulumi/rabbitmq
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: Prepare venv
        run: |
          PY=python3.14
          if ! command -v "$PY" >/dev/null 2>&1; then
            echo "python3.14 not found on runner. Install it or change the workflow."
            exit 1
          fi
          "$PY" --version
          rm -rf /data/apps/.venvs/pulumi-rabbitmq
          "$PY" -m venv /data/apps/.venvs/pulumi-rabbitmq
          /data/apps/.venvs/pulumi-rabbitmq/bin/python -m pip install --upgrade pip

      - name: Install dependencies
        run: /data/apps/.venvs/pulumi-rabbitmq/bin/python -m pip install --no-cache-dir --force-reinstall -r requirements.txt

      - name: Show requirements
        run: cat requirements.txt

      - name: Pulumi login
        run: pulumi login "${{ secrets.PULUMI_BACKEND_URL }}"

      - name: Select stack
        run: pulumi stack select "${{ inputs.stack }}"

      - name: Deploy
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
        run: pulumi up --yes
